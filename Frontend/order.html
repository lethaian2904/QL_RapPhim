<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thông tin phim</title>

    <!-- ANIMATE CSS  -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <!-- FONT AWESOME  -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- BOOTSTRAP 4  CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <!-- FONT GOOGLE  -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,400;0,700;1,300&family=Roboto+Condensed:wght@300;400;700&family=Roboto:wght@700&family=Work+Sans:wght@300;400;700&display=swap"
        rel="stylesheet">

    <!-- VENOBOX CSS  -->
    <link rel="stylesheet" href="./css/venobox.min.css">

    <!-- MAIN CSS -->
    <link rel="stylesheet" href="./css/order.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        integrity="sha512-fm/DO7bC4SOvx5zF90RVAOX4Rgg+gZvO0Ti9v5F8s+FQ6lAyj0Q3ziVT7vaFm6dbbVfU/4JbYPQsNMEq8VEocw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

</head>

<header class="container-md">
    <p class="text-right text-white mb-0">
        <i class="fa-solid fa-phone"></i>
        <span class="mx-3 border-right pr-2">012.345.6789</span>
    </p>
    <nav class="navbar navbar-expand-md">
        <a class="navbar-brand" href="#" style="color: #fff; font-size: 50px; letter-spacing: 5px; margin-left: 50px;">
            CIW
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#movieNavBar"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon">
                <i class="fa fa-bars"></i>
            </span>
        </button>

        <div class="collapse navbar-collapse" id="movieNavBar">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item active line">
                    <a class="nav-link" href="#">TRANG CHỦ <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item line">
                    <a class="nav-link" href="#">RẠP PHIM</a>
                </li>
                <li class="nav-item line">
                    <a class="nav-link" href="#">LỊCH CHIẾU</a>
                </li>
                <li class="nav-item line">
                    <a class="nav-link" href="#">ƯU ĐÃI</a>
                </li>
                <li class="nav-item line">
                    <a class="nav-link" href="#">THÀNH VIÊN</a>
                </li>
            </ul>
        </div>
    </nav>
</header>

<body>
    <div class="order-container">
        <h2>Thanh toán</h2>
        <div id="seats" class="seat-container">
            <p id="user_id">Người đặt: </p>
            <p id="order_date">Ngày đặt: </p>
            <p id="cinema_id">Tên phim: </p>
            <p id="promotion_id">Voucher đã áp dụng: </p>
            <p id="total_amount">Tổng cộng: 0đ</p>
            <button onclick="displayInformation()">Hiển thị thông tin</button>
            <button onclick="calculateTotal()">Thanh toán</button>
            <p id="payment_confirmation" style="display: none; color: green; font-weight: bold;">Đã thanh toán thành
                công!</p>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const movieId = urlParams.get('id') === 'null' ? null : urlParams.get('id');
        const selectedSeats = urlParams.get('selectedSeats');
        const popcornQuantity = urlParams.get('popcornQuantity');
        const drinkQuantity = urlParams.get('drinkQuantity');
    
        const userNameElement = document.getElementById("user_id");
        const orderDateElement = document.getElementById("order_date");
        const movieNameElement = document.getElementById("cinema_id");
        const voucherCodeElement = document.getElementById("promotion_id");
        const totalAmountElement = document.getElementById("total_amount");
        const confirmationElement = document.getElementById("payment_confirmation");
    
        async function fetchMovieDetails(movieId) {
            try {
                const response = await fetch(`http://localhost:8080/api/movies/${movieId}`);
                const data = await response.json();
                movieNameElement.textContent = "Tên phim: " + data.title;
            } catch (error) {
                console.error('Error fetching movie details:', error);
            }
        }
    
        async function fetchTicketTypes() {
            try {
                const response = await fetch('http://localhost:8080/api/ticket_types');
                const ticketTypes = await response.json();
    
                var priceVe = 50000;
                var priceBap = 30000;
                var priceNuoc = 20000;
    
                var totalAmount = priceVe * (movieId || 0) + priceBap * popcornQuantity + priceNuoc * drinkQuantity + 50000;
                totalAmountElement.textContent = "Tổng cộng: " + totalAmount.toLocaleString() + "đ";
            } catch (error) {
                console.error('Error fetching ticket types:', error);
            }
        }
    
        async function fetchPromotions() {
            try {
                const response = await fetch('http://localhost:8080/api/promotions');
                const promotions = await response.json();
    
                const currentDate = new Date();
                const activePromotion = promotions.find(promotion => {
                    const startDate = new Date(promotion.startDate);
                    const endDate = new Date(promotion.endDate);
                    return currentDate >= startDate && currentDate <= endDate;
                });
    
                var priceVe = 50000;
                var priceBap = 30000;
                var priceNuoc = 20000;
    
                var totalAmount = priceVe * (movieId || 0) + priceBap * popcornQuantity + priceNuoc * drinkQuantity + 50000;
    
                if (activePromotion) {
                    const discount = activePromotion.discount;
                    totalAmount *= (1 - discount);
                }
    
                document.getElementById("total_amount").textContent = "Tổng cộng: " + totalAmount.toLocaleString() + "đ";
            } catch (error) {
                console.error('Error fetching promotions:', error);
            }
        }
    
        function displayInformation() {
            userNameElement.textContent = "Người đặt: " + movieId;
            orderDateElement.textContent = "Số ghế đã chọn: " + selectedSeats;
            voucherCodeElement.textContent = "Số lượng bắp: " + popcornQuantity + ", Số lượng nước: " + drinkQuantity;
            fetchMovieDetails(movieId);
            fetchTicketTypes();
            fetchPromotions();
        }
    
        function calculateTotal() {
    // Assuming showtime_id is 1 and seat_id is obtained from selectedSeats
    const showtime_id = 1;
    const seat_id = selectedSeats;

    // Call the API to mark the seat as available
    fetch(`http://localhost:8080/api/showtimes/${showtime_id}/seats/${seat_id}/mark-as-available`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Failed to mark seat as available. Status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log(data); // Log the response data if needed
        confirmationElement.style.display = 'block';
        
        // Redirect to the new page after the API call is successful
        window.location.href = './order-details.html';
    })
    .catch(error => {
        console.error('Error marking seat as available:', error);
        // Handle the error as needed
    });
}

    
        // Call fetchPromotions to calculate the total amount with promotions
        fetchPromotions();
    </script>
    
</body>


</html>